<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Storing Mass Spectrometry Data in SQL Databases • MsBackendSql</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Storing Mass Spectrometry Data in SQL Databases">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">MsBackendSql</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.7.4</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/MsBackendSql.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/RforMassSpectrometry/MsBackendSql/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Storing Mass Spectrometry Data in SQL Databases</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/RforMassSpectrometry/MsBackendSql/blob/main/vignettes/MsBackendSql.Rmd" class="external-link"><code>vignettes/MsBackendSql.Rmd</code></a></small>
      <div class="d-none name"><code>MsBackendSql.Rmd</code></div>
    </div>

    
    
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
  document.querySelector("h1").className = "title";
});
</script><script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
  var links = document.links;  
  for (var i = 0, linksLength = links.length; i < linksLength; i++)
    if (links[i].hostname != window.location.hostname)
      links[i].target = '_blank';
});
</script><p><strong>Package</strong>: <em><a href="https://bioconductor.org/packages/3.21/MsBackendSql" class="external-link">MsBackendSql</a></em><br><strong>Authors</strong>: Johannes Rainer [aut, cre] (ORCID: <a href="https://orcid.org/0000-0002-6977-7147" class="external-link uri">https://orcid.org/0000-0002-6977-7147</a>), Chong Tang
[ctb], Laurent Gatto [ctb] (ORCID: <a href="https://orcid.org/0000-0002-1520-2268" class="external-link uri">https://orcid.org/0000-0002-1520-2268</a>)<br><strong>Compiled</strong>: Mon Mar 17 07:51:40 2025</p>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <em><a href="https://bioconductor.org/packages/3.21/Spectra" class="external-link">Spectra</a></em>
Bioconductor package provides a flexible and expandable infrastructure
for Mass Spectrometry (MS) data. The package supports interchangeable
use of different <em>backends</em> that provide additional file support
or different ways to store and represent MS data. The <em><a href="https://bioconductor.org/packages/3.21/MsBackendSql" class="external-link">MsBackendSql</a></em>
package provides backends to store data from whole MS experiments in SQL
databases. The data in such databases can be easily (and efficiently)
accessed using <code>Spectra</code> objects that use the
<code>MsBackendSql</code> class as an interface to the data in the
database. Such <code>Spectra</code> objects have a minimal memory
footprint and hence allow analysis of very large data sets even on
computers with limited hardware capabilities. For certain operations,
the performance of this data representation is superior to that of other
low-memory (<em>on-disk</em>) data representations such as
<code>Spectra</code>’s <code>MsBackendMzR</code> backend. Finally, the
<code>MsBackendSql</code> supports also remote data access to e.g. a
central database server hosting several large MS data sets.</p>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>The package can be installed with the <code>BiocManager</code>
package. To install <code>BiocManager</code> use
<code>install.packages("BiocManager")</code> and, after that,
<code>BiocManager::install("MsBackendSql")</code> to install this
package.</p>
</div>
<div class="section level2">
<h2 id="creating-and-using-msbackendsql-sql-databases">Creating and using <code>MsBackendSql</code> SQL databases<a class="anchor" aria-label="anchor" href="#creating-and-using-msbackendsql-sql-databases"></a>
</h2>
<p><code>MsBackendSql</code> SQL databases can be created either by
importing (raw) MS data from MS data files using the
<code><a href="../reference/MsBackendSql.html">createMsBackendSqlDatabase()</a></code> or using the
<code><a href="https://rdrr.io/pkg/ProtGenerics/man/backendInitialize.html" class="external-link">backendInitialize()</a></code> function by providing in addition to
the database connection also the full MS data to import as a
<code>DataFrame</code>. In the first example we use the
<code><a href="../reference/MsBackendSql.html">createMsBackendSqlDatabase()</a></code> function to import the full MS
data from the provided MS data files into an (empty) database. Below we
first create an empty SQLite database (in a temporary file) and use the
<code><a href="../reference/MsBackendSql.html">createMsBackendSqlDatabase()</a></code> function to create all
necessary tables in that database and import the MS data from two mzML
files (from the <code>r Biocpkg("msdata")</code> package).</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rsqlite.r-dbi.org" class="external-link">RSQLite</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">dbfile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">dbConnect</span><span class="op">(</span><span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html" class="external-link">SQLite</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">dbfile</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/Spectra" class="external-link">Spectra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/MsBackendSql" class="external-link">MsBackendSql</a></span><span class="op">)</span></span>
<span><span class="va">fls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"sciex"</span>, package <span class="op">=</span> <span class="st">"msdata"</span><span class="op">)</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/MsBackendSql.html">createMsBackendSqlDatabase</a></span><span class="op">(</span><span class="va">con</span>, <span class="va">fls</span><span class="op">)</span></span>
<span><span class="fu">dbDisconnect</span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span></code></pre></div>
<p>By default (with parameters <code>blob = TRUE</code> and
<code>peaksStorageMode = "blob2"</code>) the peaks data matrix of each
spectrum is stored as a <em>BLOB</em> data type into the database (one
entry per spectrum). This has advantages on the performance to extract
the peaks data from the database, but does not allow to filter
individual peaks by their <em>m/z</em> or intensity values directly in
the database. As an alternative (using <code>blob = FALSE</code>) it is
also possible to store the individual <em>m/z</em> and intensity values
in separate columns of the database table. This <em>long table
format</em> results however in considerably larger databases (with
potentially poorer performance). Note also that the code and backend is
optimized for MySQL/MariaDB databases by taking advantage of table
partitioning and specialized table storage options. Any other SQL
database server is however also supported (also portable, self-contained
SQLite databases). In fact, performance for <em>MsBackendSql</em>
databases with peaks data stored as <em>BLOB</em> data type is similar
for SQLite and MySQL/MariaDB databases.</p>
<p>The <em>MsBackendSql</em> package provides two backends to interact
with such databases: the <code>MsBackendSql</code> class and the
<code>MsBackendOfflineSql</code> class, that inherits all properties and
functions from the former, but does not store the connection to the
database within the object. The <code>MsBackendOfflineSql</code> object
thus supports parallel processing and allows to save/load the object
(e.g. using <code>save</code> and <code>saveRDS</code>). The
<code>MsBackendOfflineSql</code> might therefore be used as the
preferred backend to SQL databases for most applications.</p>
<p>To access the data in the database we create below a
<code>Spectra</code> object providing the database connection
information in the constructor call and specifying to use the
<code>MsBackendOfflineSql</code> as <em>backend</em> (parameter
<code>source</code>). We stored the data to a SQLite database, thus we
provide the database name (SQLite database file name) and the SQLite DBI
driver with parameters <code>dbname</code> and <code>drv</code>. Which
parameters are required to connect to the database depends on the SQL
database and the used driver. For a MySQL/MariaDB database we would use
the <code>MariaDB()</code> driver and would have to provide the database
name, user name, password as well as the host name and port through
which the database is accessible.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">Spectra</a></span><span class="op">(</span>dbname <span class="op">=</span> <span class="va">dbfile</span>, source <span class="op">=</span> <span class="fu"><a href="../reference/MsBackendOfflineSql.html">MsBackendOfflineSql</a></span><span class="op">(</span><span class="op">)</span>, drv <span class="op">=</span> <span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html" class="external-link">SQLite</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sps</span></span></code></pre></div>
<pre><code><span><span class="co">## MSn data (Spectra) with 1862 spectra in a MsBackendOfflineSql backend:</span></span>
<span><span class="co">##        msLevel precursorMz  polarity</span></span>
<span><span class="co">##      &lt;integer&gt;   &lt;numeric&gt; &lt;integer&gt;</span></span>
<span><span class="co">## 1            1          NA         1</span></span>
<span><span class="co">## 2            1          NA         1</span></span>
<span><span class="co">## 3            1          NA         1</span></span>
<span><span class="co">## 4            1          NA         1</span></span>
<span><span class="co">## 5            1          NA         1</span></span>
<span><span class="co">## ...        ...         ...       ...</span></span>
<span><span class="co">## 1858         1          NA         1</span></span>
<span><span class="co">## 1859         1          NA         1</span></span>
<span><span class="co">## 1860         1          NA         1</span></span>
<span><span class="co">## 1861         1          NA         1</span></span>
<span><span class="co">## 1862         1          NA         1</span></span>
<span><span class="co">##  ... 35 more variables/columns.</span></span>
<span><span class="co">##  Use  'spectraVariables' to list all of them.</span></span>
<span><span class="co">## Database: /tmp/RtmphWJ49j/file839b4774fbe4</span></span></code></pre>
<p><code>Spectra</code> objects allow also to change the backend to any
other backend (extending <code>MsBackend</code>) using the
<code><a href="https://rdrr.io/pkg/ProtGenerics/man/backendInitialize.html" class="external-link">setBackend()</a></code> function. Below we use this function to first
load all data into memory by changing from the
<code>MsBackendOfflineSql</code> to a <code>MsBackendMemory</code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps_mem</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/backendInitialize.html" class="external-link">setBackend</a></span><span class="op">(</span><span class="va">sps</span>, <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/MsBackend.html" class="external-link">MsBackendMemory</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sps_mem</span></span></code></pre></div>
<pre><code><span><span class="co">## MSn data (Spectra) with 1862 spectra in a MsBackendMemory backend:</span></span>
<span><span class="co">##        msLevel     rtime scanIndex</span></span>
<span><span class="co">##      &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;</span></span>
<span><span class="co">## 1            1     0.280         1</span></span>
<span><span class="co">## 2            1     0.559         2</span></span>
<span><span class="co">## 3            1     0.838         3</span></span>
<span><span class="co">## 4            1     1.117         4</span></span>
<span><span class="co">## 5            1     1.396         5</span></span>
<span><span class="co">## ...        ...       ...       ...</span></span>
<span><span class="co">## 1858         1   258.636       927</span></span>
<span><span class="co">## 1859         1   258.915       928</span></span>
<span><span class="co">## 1860         1   259.194       929</span></span>
<span><span class="co">## 1861         1   259.473       930</span></span>
<span><span class="co">## 1862         1   259.752       931</span></span>
<span><span class="co">##  ... 35 more variables/columns.</span></span>
<span><span class="co">## Processing:</span></span>
<span><span class="co">##  Switch backend from MsBackendOfflineSql to MsBackendMemory [Mon Mar 17 07:51:47 2025]</span></span></code></pre>
<p>With this function it is also possible to change from any backend to
a <code>MsBackendOfflineSql</code> (or <code>MsBackendSql</code>) in
which case a new database is created and all data from the originating
backend is stored in this database. To change the backend to an
<code>MsBackendOfflineSql</code> we need to provide the connection
information to the SQL database as additional parameters. These
parameters are the same that need to be passed to a
<code>dbConnect()</code> call to establish the connection to the
database. These parameters include the database driver (parameter
<code>drv</code>), the database name and eventually the user name, host
etc (see <code>?dbConnect</code> for more information). In the simple
example below we store the data into a SQLite database and thus only
need to provide the database name, which corresponds SQLite database
file. In our example we store the data into a temporary file.
Optionally, <code><a href="https://rdrr.io/pkg/ProtGenerics/man/backendInitialize.html" class="external-link">setBackend()</a></code> supports also the parameters
<code>blob</code> and <code>peaksDataStorage</code> described above for
the <code><a href="../reference/MsBackendSql.html">createMsBackendSqlDatabase()</a></code> function.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/backendInitialize.html" class="external-link">setBackend</a></span><span class="op">(</span><span class="va">sps_mem</span>, <span class="fu"><a href="../reference/MsBackendOfflineSql.html">MsBackendOfflineSql</a></span><span class="op">(</span><span class="op">)</span>, drv <span class="op">=</span> <span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html" class="external-link">SQLite</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                   dbname <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sps2</span></span></code></pre></div>
<pre><code><span><span class="co">## MSn data (Spectra) with 1862 spectra in a MsBackendOfflineSql backend:</span></span>
<span><span class="co">##        msLevel precursorMz  polarity</span></span>
<span><span class="co">##      &lt;integer&gt;   &lt;numeric&gt; &lt;integer&gt;</span></span>
<span><span class="co">## 1            1          NA         1</span></span>
<span><span class="co">## 2            1          NA         1</span></span>
<span><span class="co">## 3            1          NA         1</span></span>
<span><span class="co">## 4            1          NA         1</span></span>
<span><span class="co">## 5            1          NA         1</span></span>
<span><span class="co">## ...        ...         ...       ...</span></span>
<span><span class="co">## 1858         1          NA         1</span></span>
<span><span class="co">## 1859         1          NA         1</span></span>
<span><span class="co">## 1860         1          NA         1</span></span>
<span><span class="co">## 1861         1          NA         1</span></span>
<span><span class="co">## 1862         1          NA         1</span></span>
<span><span class="co">##  ... 35 more variables/columns.</span></span>
<span><span class="co">##  Use  'spectraVariables' to list all of them.</span></span>
<span><span class="co">## Database: /tmp/RtmphWJ49j/file839b577e6036</span></span>
<span><span class="co">## Processing:</span></span>
<span><span class="co">##  Switch backend from MsBackendOfflineSql to MsBackendMemory [Mon Mar 17 07:51:47 2025]</span></span>
<span><span class="co">##  Switch backend from MsBackendMemory to MsBackendOfflineSql [Mon Mar 17 07:51:47 2025]</span></span></code></pre>
<p>Similar to any other <code>Spectra</code> object we can retrieve the
available <em>spectra variables</em> using the
<code><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">spectraVariables()</a></code> function.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">spectraVariables</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "msLevel"                  "rtime"                   </span></span>
<span><span class="co">##  [3] "acquisitionNum"           "scanIndex"               </span></span>
<span><span class="co">##  [5] "dataStorage"              "dataOrigin"              </span></span>
<span><span class="co">##  [7] "centroided"               "smoothed"                </span></span>
<span><span class="co">##  [9] "polarity"                 "precScanNum"             </span></span>
<span><span class="co">## [11] "precursorMz"              "precursorIntensity"      </span></span>
<span><span class="co">## [13] "precursorCharge"          "collisionEnergy"         </span></span>
<span><span class="co">## [15] "isolationWindowLowerMz"   "isolationWindowTargetMz" </span></span>
<span><span class="co">## [17] "isolationWindowUpperMz"   "peaksCount"              </span></span>
<span><span class="co">## [19] "totIonCurrent"            "basePeakMZ"              </span></span>
<span><span class="co">## [21] "basePeakIntensity"        "ionisationEnergy"        </span></span>
<span><span class="co">## [23] "lowMZ"                    "highMZ"                  </span></span>
<span><span class="co">## [25] "mergedScan"               "mergedResultScanNum"     </span></span>
<span><span class="co">## [27] "mergedResultStartScanNum" "mergedResultEndScanNum"  </span></span>
<span><span class="co">## [29] "injectionTime"            "filterString"            </span></span>
<span><span class="co">## [31] "spectrumId"               "ionMobilityDriftTime"    </span></span>
<span><span class="co">## [33] "scanWindowLowerLimit"     "scanWindowUpperLimit"    </span></span>
<span><span class="co">## [35] "electronBeamEnergy"       "spectrum_id_"</span></span></code></pre>
<p>The MS peak data can be accessed using either the <code><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">mz()</a></code>,
<code><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">intensity()</a></code> or <code><a href="https://rdrr.io/pkg/ProtGenerics/man/peaksData.html" class="external-link">peaksData()</a></code> functions. Below we
extract the peaks matrix of the 5th spectrum and display the first 6
rows.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/peaksData.html" class="external-link">peaksData</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span><span class="op">[[</span><span class="fl">5</span><span class="op">]</span><span class="op">]</span> <span class="op">|&gt;</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##            mz intensity</span></span>
<span><span class="co">## [1,] 105.0347         0</span></span>
<span><span class="co">## [2,] 105.0362       164</span></span>
<span><span class="co">## [3,] 105.0376         0</span></span>
<span><span class="co">## [4,] 105.0391         0</span></span>
<span><span class="co">## [5,] 105.0405       328</span></span>
<span><span class="co">## [6,] 105.0420         0</span></span></code></pre>
<p>All data (peaks data or spectra variables) are
<strong>always</strong> retrieved on-the-fly from the database resulting
thus in a minimal memory footprint for the <code>Spectra</code>
object.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"KB"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 114.6 Kb</span></span></code></pre>
<p>The backend supports also adding additional spectra variables or
changing their values. Below we add 10 seconds to the retention time of
each spectrum.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps</span><span class="op">$</span><span class="va">rtime</span> <span class="op">&lt;-</span> <span class="va">sps</span><span class="op">$</span><span class="va">rtime</span> <span class="op">+</span> <span class="fl">10</span></span></code></pre></div>
<p>Such operations do however <strong>not</strong> change the data in
the database (which is always considered read-only) but are cached
locally within the backend object (in memory). The size in memory of the
object is thus higher after changing that spectra variable.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"KB"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 129.2 Kb</span></span></code></pre>
<p>Such <code>$&lt;-</code> operations can also be used to
<em>cache</em> spectra variables (temporarily) in memory which can
eventually improve performance. Below we test the time it takes to
extract the MS level from each spectrum from the database, then cache
the MS levels in memory using <code>$msLevel &lt;-</code> and test the
timing to extract these cached variable.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">msLevel</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##    0.01    0.00    0.01</span></span></code></pre>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps</span><span class="op">$</span><span class="va">msLevel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">msLevel</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">msLevel</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##   0.005   0.000   0.005</span></span></code></pre>
<p>We can also use the <code><a href="https://rdrr.io/pkg/Spectra/man/addProcessing.html" class="external-link">reset()</a></code> function to <em>reset</em>
the data to its original state (this will cause any local spectra
variables to be deleted and the backend to be initialized with the
original data in the database).</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/addProcessing.html" class="external-link">reset</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="performance-comparison-with-other-backends">Performance comparison with other backends<a class="anchor" aria-label="anchor" href="#performance-comparison-with-other-backends"></a>
</h2>
<p>The need to retrieve any spectra data on-the-fly from the database
has an impact on the performance of data access functions of
<code>Spectra</code> objects using
<code>MsBackendSql</code>/<code>MsBackendOfflineSql</code> backends. To
evaluate this we compare below the performance of the
<code>MsBackendSql</code> to other <code>Spectra</code> backends,
specifically, the <code>MsBackendMzR</code> which is the default backend
to read and represent raw MS data, and the <code>MsBackendMemory</code>
backend that keeps all MS data in memory (and is thus not suggested for
larger MS experiments). Similar to the <code>MsBackendMzR</code>, also
the <code>MsBackendSql</code> keeps only a limited amount of data in
memory. These <em>on-disk</em> backends need thus to retrieve spectra
and MS peaks data on-the-fly from either the original raw data files (in
the case of the <code>MsBackendMzR</code>) or from the SQL database (in
the case of the <code>MsBackendSql</code>). The in-memory backend
<code>MsBackendMemory</code> is supposed to provide the fastest data
access since all data is kept in memory.</p>
<p>Below we thus create <code>Spectra</code> objects from the same data
but using the different backends.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">dbConnect</span><span class="op">(</span><span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html" class="external-link">SQLite</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">dbfile</span><span class="op">)</span></span>
<span><span class="va">sps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">Spectra</a></span><span class="op">(</span><span class="va">con</span>, source <span class="op">=</span> <span class="fu"><a href="../reference/MsBackendSql.html">MsBackendSql</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sps_mzr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">Spectra</a></span><span class="op">(</span><span class="va">fls</span>, source <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/MsBackend.html" class="external-link">MsBackendMzR</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sps_im</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/backendInitialize.html" class="external-link">setBackend</a></span><span class="op">(</span><span class="va">sps_mzr</span>, backend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/MsBackend.html" class="external-link">MsBackendMemory</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>At first we compare the memory footprint of the 3 backends.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"KB"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 112.9 Kb</span></span></code></pre>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">sps_mzr</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"KB"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 401.4 Kb</span></span></code></pre>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">sps_im</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"KB"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 54509.1 Kb</span></span></code></pre>
<p>The <code>MsBackendSql</code> has the lowest memory footprint of all
3 backends because it does not keep any data in memory. The
<code>MsBackendMzR</code> keeps all spectra variables, except the MS
peaks data, in memory and has thus a larger size. The
<code>MsBackendMemory</code> keeps all data (including the MS peaks
data) in memory and has thus the largest size in memory.</p>
<p>Next we compare the performance to extract the MS level for each
spectrum from the 4 different <code>Spectra</code> objects.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/joshuaulrich/microbenchmark/" class="external-link">microbenchmark</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">msLevel</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">msLevel</a></span><span class="op">(</span><span class="va">sps_mzr</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">msLevel</a></span><span class="op">(</span><span class="va">sps_im</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Unit: microseconds</span></span>
<span><span class="co">##              expr      min        lq       mean    median        uq      max</span></span>
<span><span class="co">##      msLevel(sps) 5096.138 5248.6570 5628.30519 5449.4260 5838.2555 9299.301</span></span>
<span><span class="co">##  msLevel(sps_mzr)  377.363  412.8245  436.82355  428.8495  457.6535  629.122</span></span>
<span><span class="co">##   msLevel(sps_im)   10.790   13.3950   22.34694   21.7255   26.8050   73.968</span></span>
<span><span class="co">##  neval</span></span>
<span><span class="co">##    100</span></span>
<span><span class="co">##    100</span></span>
<span><span class="co">##    100</span></span></code></pre>
<p>Extracting MS levels is thus slowest for the
<code>MsBackendSql</code>, which is not surprising because both other
backends keep this data in memory while the <code>MsBackendSql</code>
needs to retrieve it from the database.</p>
<p>We next compare the performance to access the full peaks data from
each <code>Spectra</code> object.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/peaksData.html" class="external-link">peaksData</a></span><span class="op">(</span><span class="va">sps</span>, BPPARAM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocParallel/man/SerialParam-class.html" class="external-link">SerialParam</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/peaksData.html" class="external-link">peaksData</a></span><span class="op">(</span><span class="va">sps_mzr</span>, BPPARAM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocParallel/man/SerialParam-class.html" class="external-link">SerialParam</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/peaksData.html" class="external-link">peaksData</a></span><span class="op">(</span><span class="va">sps_im</span>, BPPARAM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocParallel/man/SerialParam-class.html" class="external-link">SerialParam</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>               times <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Unit: microseconds</span></span>
<span><span class="co">##                                         expr        min         lq      mean</span></span>
<span><span class="co">##      peaksData(sps, BPPARAM = SerialParam())  47724.511  50630.737 136997.25</span></span>
<span><span class="co">##  peaksData(sps_mzr, BPPARAM = SerialParam()) 443313.699 473775.566 698526.08</span></span>
<span><span class="co">##   peaksData(sps_im, BPPARAM = SerialParam())    352.406    369.679   2262.72</span></span>
<span><span class="co">##      median          uq       max neval</span></span>
<span><span class="co">##   66394.486  296287.223  337742.8    10</span></span>
<span><span class="co">##  487093.151 1086863.412 1133045.8    10</span></span>
<span><span class="co">##     598.375     872.055   17392.0    10</span></span></code></pre>
<p>As expected, the <code>MsBackendMemory</code> has the fasted access
to the full peaks data. The <code>MsBackendSql</code> outperforms
however the <code>MsBackendMzR</code> providing faster access to the m/z
and intensity values.</p>
<p>Performance can be improved for the <code>MsBackendMzR</code> using
parallel processing. Note that the <code>MsBackendSql</code> does
<strong>not support</strong> parallel processing and thus parallel
processing is (silently) disabled in functions such as
<code><a href="https://rdrr.io/pkg/ProtGenerics/man/peaksData.html" class="external-link">peaksData()</a></code>.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocParallel/man/MulticoreParam-class.html" class="external-link">MulticoreParam</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/peaksData.html" class="external-link">peaksData</a></span><span class="op">(</span><span class="va">sps</span>, BPPARAM <span class="op">=</span> <span class="va">m2</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/peaksData.html" class="external-link">peaksData</a></span><span class="op">(</span><span class="va">sps_mzr</span>, BPPARAM <span class="op">=</span> <span class="va">m2</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/peaksData.html" class="external-link">peaksData</a></span><span class="op">(</span><span class="va">sps_im</span>, BPPARAM <span class="op">=</span> <span class="va">m2</span><span class="op">)</span>,</span>
<span>               times <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Unit: microseconds</span></span>
<span><span class="co">##                              expr        min         lq        mean      median</span></span>
<span><span class="co">##      peaksData(sps, BPPARAM = m2)  46378.242  55116.357  60882.6762  60141.8370</span></span>
<span><span class="co">##  peaksData(sps_mzr, BPPARAM = m2) 428571.292 486742.013 708184.1580 661306.4715</span></span>
<span><span class="co">##   peaksData(sps_im, BPPARAM = m2)    421.696    835.187    827.6728    868.9195</span></span>
<span><span class="co">##          uq         max neval</span></span>
<span><span class="co">##   68905.855   74470.497    10</span></span>
<span><span class="co">##  834908.611 1119557.942    10</span></span>
<span><span class="co">##     935.384    1028.056    10</span></span></code></pre>
<p>We next compare the performance of subsetting operations.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">filterRt</a></span><span class="op">(</span><span class="va">sps</span>, rt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">filterRt</a></span><span class="op">(</span><span class="va">sps_mzr</span>, rt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">filterRt</a></span><span class="op">(</span><span class="va">sps_im</span>, rt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Unit: microseconds</span></span>
<span><span class="co">##                                expr      min       lq      mean    median</span></span>
<span><span class="co">##      filterRt(sps, rt = c(50, 100)) 1948.632 1995.860 2230.2510 2027.4285</span></span>
<span><span class="co">##  filterRt(sps_mzr, rt = c(50, 100)) 1244.629 1313.572 1466.7465 1350.6075</span></span>
<span><span class="co">##   filterRt(sps_im, rt = c(50, 100))  398.333  433.258  465.0411  449.8285</span></span>
<span><span class="co">##         uq       max neval</span></span>
<span><span class="co">##  2076.5600 14737.826   100</span></span>
<span><span class="co">##  1480.9600  9395.300   100</span></span>
<span><span class="co">##   482.4595  1141.708   100</span></span></code></pre>
<p>The two <em>on-disk</em> backends <code>MsBackendSql</code> and
<code>MsBackendMzR</code> show a comparable performance for this
operation. This filtering does involves access to a spectra variables
(the retention time in this case) which, for the
<code>MsBackendSql</code> needs first to be retrieved from the backend.
The <code>MsBackendSql</code> backend allows however also to
<em>cache</em> spectra variables (i.e. they are stored within the
<code>MsBackendSql</code> object). Any access to such cached spectra
variables can eventually be faster because no dedicated SQL query is
needed.</p>
<p>To evaluate the performance of a <em>pure</em> subsetting operation
we first define the indices of 10 random spectra and subset the
<code>Spectra</code> objects to these.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="va">sps</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span>,</span>
<span>               <span class="va">sps_mzr</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span>,</span>
<span>               <span class="va">sps_im</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Unit: microseconds</span></span>
<span><span class="co">##          expr     min       lq     mean   median       uq      max neval</span></span>
<span><span class="co">##      sps[idx] 134.220 143.8035 152.9504 152.3395 159.6530  226.753   100</span></span>
<span><span class="co">##  sps_mzr[idx] 674.848 699.9240 723.7425 710.0985 721.6550 1686.854   100</span></span>
<span><span class="co">##   sps_im[idx] 236.922 247.3460 256.4294 255.7365 260.1395  327.320   100</span></span></code></pre>
<p>Here the <code>MsBackendSql</code> outperforms the other backends
because it does not keep any data in memory and hence does not need to
subset these. The two other backends need to subset the data they keep
in memory which is in both cases a data frame with either a reduced set
of spectra variables or the full MS data.</p>
<p>At last we compare also the extraction of the peaks data from the
such subset <code>Spectra</code> objects.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps_10</span> <span class="op">&lt;-</span> <span class="va">sps</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span></span>
<span><span class="va">sps_mzr_10</span> <span class="op">&lt;-</span> <span class="va">sps_mzr</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span></span>
<span><span class="va">sps_im_10</span> <span class="op">&lt;-</span> <span class="va">sps_im</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/peaksData.html" class="external-link">peaksData</a></span><span class="op">(</span><span class="va">sps_10</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/peaksData.html" class="external-link">peaksData</a></span><span class="op">(</span><span class="va">sps_mzr_10</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/peaksData.html" class="external-link">peaksData</a></span><span class="op">(</span><span class="va">sps_im_10</span><span class="op">)</span>,</span>
<span>               times <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Unit: microseconds</span></span>
<span><span class="co">##                   expr       min        lq       mean     median        uq</span></span>
<span><span class="co">##      peaksData(sps_10)  1900.351  1993.435  2505.0174  2202.2290  3159.238</span></span>
<span><span class="co">##  peaksData(sps_mzr_10) 74106.808 76473.491 80682.8475 79040.6980 83277.198</span></span>
<span><span class="co">##   peaksData(sps_im_10)   369.468   393.463   535.7353   570.7885   653.417</span></span>
<span><span class="co">##        max neval</span></span>
<span><span class="co">##   3193.532    10</span></span>
<span><span class="co">##  97232.225    10</span></span>
<span><span class="co">##    688.263    10</span></span></code></pre>
<p>The <code>MsBackendSql</code> outperforms the
<code>MsBackendMzR</code> while, not unexpectedly, the
<code>MsBackendMemory</code> provides fasted access.</p>
<div class="section level3">
<h3 id="considerations-for-database-systemsservers">Considerations for database systems/servers<a class="anchor" aria-label="anchor" href="#considerations-for-database-systemsservers"></a>
</h3>
<p>The backends from the <em>MsBackendSql</em> package use standard SQL
calls to retrieve MS data from the database and hence any SQL database
system (for which an R package is available) is supported. SQLite-based
databases would represent the easiest and most user friendly solution
since no database server administration and user management is required.
Indeed, performance of SQLite is very high, even for very large data
sets. Server-based databases on the other hand have the advantage to
enable a centralized storage and control of MS data (inclusive user
management etc). Also, such server systems would also allow data set or
server-specific configurations to improve performance.</p>
<p>A comparison between a SQLite-based with a MariaDB-based
<em>MsBackendSql</em> database for a large data set comprising over
8,000 samples and over 15,000,000 spectra is available <a href="https://github.com/rformassspectrometry/MsBackendSql/issues/15" class="external-link">here</a>.
In brief, performance to extract data was comparable and for individual
spectra variables even faster for the SQLite database. Only when more
complex SQL queries were involved (combining several primary keys or
data fields) the more advanced MariaDB database outperformed SQLite.</p>
</div>
</div>
<div class="section level2">
<h2 id="other-properties-of-the-msbackendsql">Other properties of the <code>MsBackendSql</code><a class="anchor" aria-label="anchor" href="#other-properties-of-the-msbackendsql"></a>
</h2>
<p>The <code>MsBackendSql</code> backend does not support parallel
processing since the database connection can not be shared across the
different (parallel) processes. Thus, all methods on
<code>Spectra</code> objects that use a <code>MsBackendSql</code> will
automatically (and silently) disable parallel processing even if a
dedicated parallel processing setup was passed along with the
<code>BPPARAM</code> method.</p>
<p>Some functions on <code>Spectra</code> objects require to load the MS
peak data (i.e., m/z and intensity values) into memory. For very large
data sets (or computers with limited hardware resources) such function
calls can cause out-of-memory errors. One example is the
<code><a href="https://rdrr.io/r/base/lengths.html" class="external-link">lengths()</a></code> function that determines the number of peaks per
spectrum by loading the peak matrix first into memory. Such functions
should ideally be called using the <code>peaksapply()</code> function
with parameter <code>chunkSize</code> (e.g.,
<code>peaksapply(sps, lengths, chunkSize = 5000L)</code>). Instead of
processing the full data set, the data will be first split into chunks
of size <code>chunkSize</code> that are stepwise processed. Hence, only
data from <code>chunkSize</code> spectra is loaded into memory in one
iteration.</p>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>The <code>MsBackendSql</code> provides an MS data representations and
storage mode with a minimal memory footprint (in R) that is still
comparably efficient for standard processing and subsetting operations.
This backend is specifically useful for very large MS data sets, that
could even be hosted on remote (MySQL/MariaDB) servers. A potential use
case for this backend could thus be to set up a central storage place
for MS experiments with data analysts connecting remotely to this server
to perform initial data exploration and filtering. After subsetting to a
smaller data set of interest, users could then retrieve/download this
data by changing the backend to e.g. a <code>MsBackendMemory</code>,
which would result in a <em>download</em> of the full data to the user
computer’s memory.</p>
</div>
<div class="section level2">
<h2 id="session-information">Session information<a class="anchor" aria-label="anchor" href="#session-information"></a>
</h2>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## R Under development (unstable) (2025-02-24 r87814)</span></span>
<span><span class="co">## Platform: x86_64-pc-linux-gnu</span></span>
<span><span class="co">## Running under: Ubuntu 24.04.1 LTS</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Matrix products: default</span></span>
<span><span class="co">## BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3 </span></span>
<span><span class="co">## LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.26.so;  LAPACK version 3.12.0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## locale:</span></span>
<span><span class="co">##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              </span></span>
<span><span class="co">##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    </span></span>
<span><span class="co">##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   </span></span>
<span><span class="co">##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 </span></span>
<span><span class="co">##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            </span></span>
<span><span class="co">## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## time zone: UTC</span></span>
<span><span class="co">## tzcode source: system (glibc)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attached base packages:</span></span>
<span><span class="co">## [1] stats4    stats     graphics  grDevices utils     datasets  methods  </span></span>
<span><span class="co">## [8] base     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## other attached packages:</span></span>
<span><span class="co">## [1] microbenchmark_1.5.0 RSQLite_2.3.9        MsBackendSql_1.7.4  </span></span>
<span><span class="co">## [4] Spectra_1.17.9       BiocParallel_1.41.2  S4Vectors_0.45.4    </span></span>
<span><span class="co">## [7] BiocGenerics_0.53.6  generics_0.1.3       BiocStyle_2.35.0    </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## loaded via a namespace (and not attached):</span></span>
<span><span class="co">##  [1] sass_0.4.9             MsCoreUtils_1.19.1     stringi_1.8.4         </span></span>
<span><span class="co">##  [4] hms_1.1.3              digest_0.6.37          evaluate_1.0.3        </span></span>
<span><span class="co">##  [7] bookdown_0.42          blob_1.2.4             fastmap_1.2.0         </span></span>
<span><span class="co">## [10] jsonlite_1.9.1         ProtGenerics_1.39.2    progress_1.2.3        </span></span>
<span><span class="co">## [13] mzR_2.41.4             DBI_1.2.3              BiocManager_1.30.25   </span></span>
<span><span class="co">## [16] codetools_0.2-20       textshaping_1.0.0      jquerylib_0.1.4       </span></span>
<span><span class="co">## [19] cli_3.6.4              rlang_1.1.5            crayon_1.5.3          </span></span>
<span><span class="co">## [22] Biobase_2.67.0         bit64_4.6.0-1          cachem_1.1.0          </span></span>
<span><span class="co">## [25] yaml_2.3.10            tools_4.5.0            parallel_4.5.0        </span></span>
<span><span class="co">## [28] memoise_2.0.1          ncdf4_1.23             fastmatch_1.1-6       </span></span>
<span><span class="co">## [31] vctrs_0.6.5            R6_2.6.1               lifecycle_1.0.4       </span></span>
<span><span class="co">## [34] fs_1.6.5               htmlwidgets_1.6.4      IRanges_2.41.3        </span></span>
<span><span class="co">## [37] bit_4.6.0              clue_0.3-66            MASS_7.3-65           </span></span>
<span><span class="co">## [40] ragg_1.3.3             cluster_2.1.8.1        pkgconfig_2.0.3       </span></span>
<span><span class="co">## [43] desc_1.4.3             pkgdown_2.1.1.9000     bslib_0.9.0           </span></span>
<span><span class="co">## [46] Rcpp_1.0.14            data.table_1.17.0      systemfonts_1.2.1     </span></span>
<span><span class="co">## [49] xfun_0.51              knitr_1.50             htmltools_0.5.8.1     </span></span>
<span><span class="co">## [52] rmarkdown_2.29         compiler_4.5.0         prettyunits_1.2.0     </span></span>
<span><span class="co">## [55] MetaboCoreUtils_1.15.0</span></span></code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Johannes Rainer.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.9000.</p>
</div>

    </footer>
</div>





  </body>
</html>
