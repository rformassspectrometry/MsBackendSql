<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="MsBackendSql">
<title>Storing Mass Spectrometry Data in SQL Databases • MsBackendSql</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Storing Mass Spectrometry Data in SQL Databases">
<meta property="og:description" content="MsBackendSql">
<meta property="og:image" content="https://rformassspectrometry.github.io/MsBackendSql/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">MsBackendSql</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.99.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item">
  <a class="nav-link" href="../articles/MsBackendSql.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/RforMassSpectrometry/MsBackendSql/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Storing Mass Spectrometry Data in SQL Databases</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/RforMassSpectrometry/MsBackendSql/blob/HEAD/vignettes/MsBackendSql.Rmd" class="external-link"><code>vignettes/MsBackendSql.Rmd</code></a></small>
      <div class="d-none name"><code>MsBackendSql.Rmd</code></div>
    </div>

    
    
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
  document.querySelector("h1").className = "title";
});
</script><script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
  var links = document.links;  
  for (var i = 0, linksLength = links.length; i < linksLength; i++)
    if (links[i].hostname != window.location.hostname)
      links[i].target = '_blank';
});
</script><p><strong>Package</strong>: <em><a href="https://bioconductor.org/packages/3.17/MsBackendSql" class="external-link">MsBackendSql</a></em><br><strong>Authors</strong>: Johannes Rainer [aut, cre] (<a href="https://orcid.org/0000-0002-6977-7147" class="external-link uri">https://orcid.org/0000-0002-6977-7147</a>), Chong Tang
[ctb], Laurent Gatto [ctb] (<a href="https://orcid.org/0000-0002-1520-2268" class="external-link uri">https://orcid.org/0000-0002-1520-2268</a>)<br><strong>Compiled</strong>: Wed Feb 1 09:43:16 2023</p>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <em><a href="https://bioconductor.org/packages/3.17/Spectra" class="external-link">Spectra</a></em>
Bioconductor package provides a flexible and expandable infrastructure
for Mass Spectrometry (MS) data. The package supports interchangeable
use of different <em>backends</em> that provide additional file support
or different ways to store and represent MS data. The <em><a href="https://bioconductor.org/packages/3.17/MsBackendSql" class="external-link">MsBackendSql</a></em>
package provides a backend to store data from whole MS experiments in
SQL databases. The data in such databases can be easily (and
efficiently) accessed using <code>Spectra</code> objects that use the
<code>MsBackendSql</code> class as an interface to the data in the
database. Such <code>Spectra</code> objects have a minimal memory
footprint and hence allow analysis of very large data sets even on
computers with limited hardware capabilities. For certain operations,
the performance of this data representation is superior to that of other
low-memory (<em>on-disk</em>) data representations such as
<code>Spectra</code>’s <code>MsBackendMzR</code> backend. Finally, the
<code>MsBackendSql</code> supports also remote data access to e.g. a
central database server hosting several large MS data sets.</p>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>The package can be installed with the <code>BiocManager</code>
package. To install <code>BiocManager</code> use
<code>install.packages("BiocManager")</code> and, after that,
<code>BiocManager::install("MsBackendSql")</code> to install this
package.</p>
</div>
<div class="section level2">
<h2 id="creating-msbackendsql-sql-databases">Creating <code>MsBackendSql</code> SQL databases<a class="anchor" aria-label="anchor" href="#creating-msbackendsql-sql-databases"></a>
</h2>
<p>The <em><a href="https://bioconductor.org/packages/3.17/MsBackendSql" class="external-link">MsBackendSql</a></em>
provides, with <code>createMsBackendSqlDatabase</code>, a function to
import (raw) MS data and store it to an SQL database. This function
takes a connection to an (empty) database and the names of the files
from which the data should be imported as input parameters and stores
the full data into the database. Below we create an empty SQLite
database (in a temporary file) and fill that with MS data from two mzML
files (from the <em><a href="https://bioconductor.org/packages/3.17/msdata" class="external-link">msdata</a></em>
package).</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rsqlite.r-dbi.org" class="external-link">RSQLite</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">dbfile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">dbConnect</span><span class="op">(</span><span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html" class="external-link">SQLite</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">dbfile</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/MsBackendSql" class="external-link">MsBackendSql</a></span><span class="op">)</span></span>
<span><span class="va">fls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"sciex"</span>, package <span class="op">=</span> <span class="st">"msdata"</span><span class="op">)</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/MsBackendSql.html">createMsBackendSqlDatabase</a></span><span class="op">(</span><span class="va">con</span>, <span class="va">fls</span><span class="op">)</span></span></code></pre></div>
<p>By default the m/z and intensity values are stored as <em>BLOB</em>
data types in the database. This has advantages on the performance to
extract peaks data from the database but would for example not allow to
filter peaks by m/z values directly in the database. As an alternative
it is also possible to the individual m/z and intensity values in
separate rows of the database table. This <em>long table format</em>
results however in considerably larger databases (with potentially
poorer performance). Note also that the code and backend is optimized
for MySQL/MariaDB databases by taking advantage of table partitioning
and specialized table storage options. Any other SQL database server is
however also supported (also portable, self-contained SQLite
databases).</p>
<p>We can now create a <code>Spectra</code> object by providing the
connection to the database in the constructor call and specifying to use
the <code>MsBackendSql</code> (provided by this package) as
<em>backend</em> using the <code>source</code> parameter:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">Spectra</a></span><span class="op">(</span><span class="va">con</span>, source <span class="op">=</span> <span class="fu"><a href="../reference/MsBackendSql.html">MsBackendSql</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sps</span></span></code></pre></div>
<pre><code><span><span class="co">## MSn data (Spectra) with 1862 spectra in a MsBackendSql backend:</span></span>
<span><span class="co">##        msLevel precursorMz  polarity</span></span>
<span><span class="co">##      &lt;integer&gt;   &lt;numeric&gt; &lt;integer&gt;</span></span>
<span><span class="co">## 1            1          NA         1</span></span>
<span><span class="co">## 2            1          NA         1</span></span>
<span><span class="co">## 3            1          NA         1</span></span>
<span><span class="co">## 4            1          NA         1</span></span>
<span><span class="co">## 5            1          NA         1</span></span>
<span><span class="co">## ...        ...         ...       ...</span></span>
<span><span class="co">## 1858         1          NA         1</span></span>
<span><span class="co">## 1859         1          NA         1</span></span>
<span><span class="co">## 1860         1          NA         1</span></span>
<span><span class="co">## 1861         1          NA         1</span></span>
<span><span class="co">## 1862         1          NA         1</span></span>
<span><span class="co">##  ... 34 more variables/columns.</span></span>
<span><span class="co">##  Use  'spectraVariables' to list all of them.</span></span>
<span><span class="co">## Database: /tmp/RtmpZMG6ys/file94d66f4f9f6</span></span></code></pre>
<p>Similar to any other <code>Spectra</code> object we can retrieve the
available <em>spectra variables</em> using the
<code>spectraVariables</code> function.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">spectraVariables</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "msLevel"                  "rtime"                   </span></span>
<span><span class="co">##  [3] "acquisitionNum"           "scanIndex"               </span></span>
<span><span class="co">##  [5] "dataStorage"              "dataOrigin"              </span></span>
<span><span class="co">##  [7] "centroided"               "smoothed"                </span></span>
<span><span class="co">##  [9] "polarity"                 "precScanNum"             </span></span>
<span><span class="co">## [11] "precursorMz"              "precursorIntensity"      </span></span>
<span><span class="co">## [13] "precursorCharge"          "collisionEnergy"         </span></span>
<span><span class="co">## [15] "isolationWindowLowerMz"   "isolationWindowTargetMz" </span></span>
<span><span class="co">## [17] "isolationWindowUpperMz"   "peaksCount"              </span></span>
<span><span class="co">## [19] "totIonCurrent"            "basePeakMZ"              </span></span>
<span><span class="co">## [21] "basePeakIntensity"        "ionisationEnergy"        </span></span>
<span><span class="co">## [23] "lowMZ"                    "highMZ"                  </span></span>
<span><span class="co">## [25] "mergedScan"               "mergedResultScanNum"     </span></span>
<span><span class="co">## [27] "mergedResultStartScanNum" "mergedResultEndScanNum"  </span></span>
<span><span class="co">## [29] "injectionTime"            "filterString"            </span></span>
<span><span class="co">## [31] "spectrumId"               "ionMobilityDriftTime"    </span></span>
<span><span class="co">## [33] "scanWindowLowerLimit"     "scanWindowUpperLimit"    </span></span>
<span><span class="co">## [35] "spectrum_id_"</span></span></code></pre>
<p>The MS peak data can be accessed using either the <code>mz</code>,
<code>intensity</code> or <code>peaksData</code> functions. Below we
extract the peaks matrix of the 5th spectrum and display the first 6
rows.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">peaksData</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span><span class="op">[[</span><span class="fl">5</span><span class="op">]</span><span class="op">]</span> <span class="op">|&gt;</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##            mz intensity</span></span>
<span><span class="co">## [1,] 105.0347         0</span></span>
<span><span class="co">## [2,] 105.0362       164</span></span>
<span><span class="co">## [3,] 105.0376         0</span></span>
<span><span class="co">## [4,] 105.0391         0</span></span>
<span><span class="co">## [5,] 105.0405       328</span></span>
<span><span class="co">## [6,] 105.0420         0</span></span></code></pre>
<p>All data (peaks data or spectra variables) are
<strong>always</strong> retrieved on the fly from the database resulting
thus in a minimal memory footprint for the <code>Spectra</code>
object.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"KB"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 91.3 Kb</span></span></code></pre>
<p>The backend supports also adding additional spectra variables or
changing their values. Below we add 10 seconds to the retention time of
each spectrum.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps</span><span class="op">$</span><span class="va">rtime</span> <span class="op">&lt;-</span> <span class="va">sps</span><span class="op">$</span><span class="va">rtime</span> <span class="op">+</span> <span class="fl">10</span></span></code></pre></div>
<p>Such operations do however <strong>not</strong> change the data in
the database (which is always considered read-only) but are cached
locally within the backend object (in memory). The size in memory of the
object is thus higher after changing that spectra variable.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"KB"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 106 Kb</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="performance-comparison-with-other-backends">Performance comparison with other backends<a class="anchor" aria-label="anchor" href="#performance-comparison-with-other-backends"></a>
</h2>
<p>The need to retrieve any spectra data on-the-fly from the database
will have an impact on the performance of data access function of
<code>Spectra</code> objects using the <code>MsBackendSql</code>
backends. To evaluate its impact we next compare the performance of the
<code>MsBackendSql</code> to other <code>Spectra</code> backends,
specifically, the <code>MsBackendMzR</code> which is the default backend
to read and represent raw MS data, and the <code>MsBackendMemory</code>
backend that keeps all MS data in memory (and is thus not suggested for
larger MS experiments). Similar to the <code>MsBackendMzR</code>, also
the <code>MsBackendSql</code> keeps only a limited amount of data in
memory. These <em>on-disk</em> backends need thus to retrieve spectra
and MS peaks data on-the-fly from either the original raw data files (in
the case of the <code>MsBackendMzR</code>) or from the SQL database (in
the case of the <code>MsBackendSql</code>). The in-memory backend
<code>MsBackendMemory</code> is supposed to provide the fastest data
access since all data is kept in memory.</p>
<p>Below we thus create <code>Spectra</code> objects from the same data
but using the different backends.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">Spectra</a></span><span class="op">(</span><span class="va">con</span>, source <span class="op">=</span> <span class="fu"><a href="../reference/MsBackendSql.html">MsBackendSql</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sps_mzr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">Spectra</a></span><span class="op">(</span><span class="va">fls</span>, source <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/MsBackend.html" class="external-link">MsBackendMzR</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sps_im</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">setBackend</a></span><span class="op">(</span><span class="va">sps_mzr</span>, backend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/MsBackend.html" class="external-link">MsBackendMemory</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>At first we compare the memory footprint of the 3 backends.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"KB"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 91.3 Kb</span></span></code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">sps_mzr</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"KB"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 386.2 Kb</span></span></code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">sps_im</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"KB"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 54494.3 Kb</span></span></code></pre>
<p>The <code>MsBackendSql</code> has the lowest memory footprint of all
3 backends because it does not keep any data in memory. The
<code>MsBackendMzR</code> keeps all spectra variables, except the MS
peaks data, in memory and has thus a larger size. The
<code>MsBackendMemory</code> keeps all data (including the MS peaks
data) in memory and has thus the largest size in memory.</p>
<p>Next we compare the performance to extract the MS level for each
spectrum from the 4 different <code>Spectra</code> objects.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/joshuaulrich/microbenchmark/" class="external-link">microbenchmark</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">msLevel</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">msLevel</a></span><span class="op">(</span><span class="va">sps_mzr</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">msLevel</a></span><span class="op">(</span><span class="va">sps_im</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Unit: microseconds</span></span>
<span><span class="co">##              expr    min      lq     mean  median      uq     max neval</span></span>
<span><span class="co">##      msLevel(sps) 8365.1 8767.65 9302.708 9109.35 9744.25 14736.2   100</span></span>
<span><span class="co">##  msLevel(sps_mzr)  584.3  602.40  660.585  628.05  707.35   952.4   100</span></span>
<span><span class="co">##   msLevel(sps_im)   12.5   20.05   32.922   35.65   42.05    57.1   100</span></span></code></pre>
<p>Extracting MS levels is thus slowest for the
<code>MsBackendSql</code>, which is not surprising because both other
backends keep this data in memory while the <code>MsBackendSql</code>
needs to retrieve it from the database.</p>
<p>We next compare the performance to access the full peaks data from
each <code>Spectra</code> object.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">peaksData</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">peaksData</a></span><span class="op">(</span><span class="va">sps_mzr</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">peaksData</a></span><span class="op">(</span><span class="va">sps_im</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Unit: microseconds</span></span>
<span><span class="co">##                expr      min       lq      mean   median       uq       max</span></span>
<span><span class="co">##      peaksData(sps) 158688.4 182019.9 342622.91 385470.4 414094.0  655867.6</span></span>
<span><span class="co">##  peaksData(sps_mzr) 572129.9 616894.4 859945.02 654983.6 951682.5 1531847.0</span></span>
<span><span class="co">##   peaksData(sps_im)    945.8   1343.7   2853.64   1381.2   1575.2   15993.1</span></span>
<span><span class="co">##  neval</span></span>
<span><span class="co">##     10</span></span>
<span><span class="co">##     10</span></span>
<span><span class="co">##     10</span></span></code></pre>
<p>As expected, the <code>MsBackendMemory</code> has the fasted access
to the full peaks data. The <code>MsBackendSql</code> outperforms
however the <code>MsBackendMzR</code> providing faster access to the m/z
and intensity values.</p>
<p>We next compare the performance of subsetting operations.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">filterRt</a></span><span class="op">(</span><span class="va">sps</span>, rt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">filterRt</a></span><span class="op">(</span><span class="va">sps_mzr</span>, rt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">filterRt</a></span><span class="op">(</span><span class="va">sps_im</span>, rt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Unit: microseconds</span></span>
<span><span class="co">##                                expr    min      lq     mean  median      uq</span></span>
<span><span class="co">##      filterRt(sps, rt = c(50, 100)) 3713.9 3818.05 4078.593 3915.05 4049.25</span></span>
<span><span class="co">##  filterRt(sps_mzr, rt = c(50, 100)) 2972.5 3070.15 3286.168 3134.10 3399.15</span></span>
<span><span class="co">##   filterRt(sps_im, rt = c(50, 100))  614.0  653.80  708.276  689.55  743.05</span></span>
<span><span class="co">##      max neval</span></span>
<span><span class="co">##  14793.1   100</span></span>
<span><span class="co">##  10269.3   100</span></span>
<span><span class="co">##   1765.2   100</span></span></code></pre>
<p>The two <em>on-disk</em> backends <code>MsBackendSql</code> and
<code>MsBackendMzR</code> show a comparable performance for this
operation. This filtering does however involve also access to spectra
variables (the retention time in this case). To evaluate the performance
of a <em>pure</em> subsetting operation we first define the indices of
10 random spectra and subset the <code>Spectra</code> objects to
these.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="va">sps</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span>,</span>
<span>               <span class="va">sps_mzr</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span>,</span>
<span>               <span class="va">sps_im</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Unit: microseconds</span></span>
<span><span class="co">##          expr   min     lq    mean median     uq    max neval</span></span>
<span><span class="co">##      sps[idx] 165.9 190.10 215.853 225.65 230.95  431.4   100</span></span>
<span><span class="co">##  sps_mzr[idx] 891.2 905.05 916.914 911.50 924.05 1156.7   100</span></span>
<span><span class="co">##   sps_im[idx] 244.7 257.90 280.890 279.65 304.55  327.8   100</span></span></code></pre>
<p>Here the <code>MsBackendSql</code> outperforms the other backends
because it does not keep any data in memory and hence does not need to
subset these. The two other backends need to subset the data they keep
in memory which is in both cases a data frame with either a reduced set
of spectra variables or the full MS data.</p>
<p>At last we compare also the extraction of the peaks data from the
such subset <code>Spectra</code> objects.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps_10</span> <span class="op">&lt;-</span> <span class="va">sps</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span></span>
<span><span class="va">sps_mzr_10</span> <span class="op">&lt;-</span> <span class="va">sps_mzr</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span></span>
<span><span class="va">sps_im_10</span> <span class="op">&lt;-</span> <span class="va">sps_im</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">peaksData</a></span><span class="op">(</span><span class="va">sps_10</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">peaksData</a></span><span class="op">(</span><span class="va">sps_mzr_10</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/hidden_aliases.html" class="external-link">peaksData</a></span><span class="op">(</span><span class="va">sps_im_10</span><span class="op">)</span>,</span>
<span>               times <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Unit: microseconds</span></span>
<span><span class="co">##                   expr     min      lq     mean   median      uq     max neval</span></span>
<span><span class="co">##      peaksData(sps_10)  2177.8  2782.2  3664.68  3259.35  4851.7  5134.7    10</span></span>
<span><span class="co">##  peaksData(sps_mzr_10) 59030.9 60201.8 61429.44 61183.15 61426.0 66845.6    10</span></span>
<span><span class="co">##   peaksData(sps_im_10)   390.8   431.7   526.18   460.15   630.8   849.1    10</span></span></code></pre>
<p>The <code>MsBackendSql</code> outperforms the
<code>MsBackendMzR</code> while, not unexpectedly, the
<code>MsBackendMemory</code> provides fasted access.</p>
</div>
<div class="section level2">
<h2 id="other-properties-of-the-msbackendsql">Other properties of the <code>MsBackendSql</code><a class="anchor" aria-label="anchor" href="#other-properties-of-the-msbackendsql"></a>
</h2>
<p>The <code>MsBackendSql</code> backend does not support parallel
processing since the database connection can not be shared across the
different parallel processes. Thus, it is suggested to either disable
parallel processing in general in the R session with
<code>register(SerialParam())</code> or to pass the parameter
<code>BPPARAM = SerialParam()</code> to functions such as
<code>peaksData</code>.</p>
<p>Some functions on <code>Spectra</code> objects require to load the MS
peak data (i.e., m/z and intensity values) into memory. For very large
data sets (or computers with limited hardware resources) such function
calls can cause out-of-memory errors. One example is the
<code>lengths</code> function that determines the number of peaks per
spectrum by loading the peak matrix first into memory. Such functions
should ideally be called using the <code>peaksapply</code> function with
parameter <code>chunkSize</code> (e.g.,
<code>peaksapply(sps, lengths, chunkSize = 5000L)</code>). Instead of
processing the full data set, the data will be first split into chunks
of size <code>chunkSize</code> that are stepwise processed. Hence, only
data from <code>chunkSize</code> spectra is loaded into memory in one
iteration.</p>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>The <code>MsBackendSql</code> provides an MS data representations and
storage mode with a minimal memory footprint (in R) that is still
comparably efficient for standard processing and subsetting operations.
This backend is specifically useful for very large MS data sets, that
could even be hosted on remote (MySQL/MariaDB) servers. A potential use
case for this backend could thus be to set up a central storage place
for MS experiments with data analysts connecting remotely to this server
to perform initial data exploration and filtering. After subsetting to a
smaller data set of interest, users could then retrieve/download this
data by changing the backend to e.g. a <code>MsBackendMemory</code>,
which would result in a <em>download</em> of the full data to the user
computer’s memory.</p>
</div>
<div class="section level2">
<h2 id="session-information">Session information<a class="anchor" aria-label="anchor" href="#session-information"></a>
</h2>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## R Under development (unstable) (2023-01-26 r83699)</span></span>
<span><span class="co">## Platform: x86_64-pc-linux-gnu (64-bit)</span></span>
<span><span class="co">## Running under: Ubuntu 22.04.1 LTS</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Matrix products: default</span></span>
<span><span class="co">## BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3 </span></span>
<span><span class="co">## LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.20.so;  LAPACK version 3.10.0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## locale:</span></span>
<span><span class="co">##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              </span></span>
<span><span class="co">##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    </span></span>
<span><span class="co">##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   </span></span>
<span><span class="co">##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 </span></span>
<span><span class="co">##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            </span></span>
<span><span class="co">## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## time zone: UTC</span></span>
<span><span class="co">## tzcode source: system (glibc)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attached base packages:</span></span>
<span><span class="co">## [1] stats4    stats     graphics  grDevices utils     datasets  methods  </span></span>
<span><span class="co">## [8] base     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## other attached packages:</span></span>
<span><span class="co">## [1] microbenchmark_1.4.9 RSQLite_2.2.20       MsBackendSql_0.99.2 </span></span>
<span><span class="co">## [4] Spectra_1.9.6        ProtGenerics_1.31.0  BiocParallel_1.33.9 </span></span>
<span><span class="co">## [7] S4Vectors_0.37.3     BiocGenerics_0.45.0  BiocStyle_2.27.1    </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## loaded via a namespace (and not attached):</span></span>
<span><span class="co">##  [1] sass_0.4.5          MsCoreUtils_1.11.3  stringi_1.7.12     </span></span>
<span><span class="co">##  [4] hms_1.1.2           digest_0.6.31       magrittr_2.0.3     </span></span>
<span><span class="co">##  [7] evaluate_0.20       bookdown_0.32       blob_1.2.3         </span></span>
<span><span class="co">## [10] fastmap_1.1.0       rprojroot_2.0.3     jsonlite_1.8.4     </span></span>
<span><span class="co">## [13] progress_1.2.2      mzR_2.33.0          DBI_1.1.3          </span></span>
<span><span class="co">## [16] BiocManager_1.30.19 purrr_1.0.1         codetools_0.2-18   </span></span>
<span><span class="co">## [19] textshaping_0.3.6   jquerylib_0.1.4     cli_3.6.0          </span></span>
<span><span class="co">## [22] rlang_1.0.6         crayon_1.5.2        Biobase_2.59.0     </span></span>
<span><span class="co">## [25] bit64_4.0.5         ellipsis_0.3.2      cachem_1.0.6       </span></span>
<span><span class="co">## [28] yaml_2.3.7          tools_4.3.0         parallel_4.3.0     </span></span>
<span><span class="co">## [31] memoise_2.0.1       ncdf4_1.21          vctrs_0.5.2        </span></span>
<span><span class="co">## [34] R6_2.5.1            lifecycle_1.0.3     stringr_1.5.0      </span></span>
<span><span class="co">## [37] bit_4.0.5           fs_1.6.0            IRanges_2.33.0     </span></span>
<span><span class="co">## [40] clue_0.3-64         MASS_7.3-58.2       ragg_1.2.5         </span></span>
<span><span class="co">## [43] cluster_2.1.4       pkgconfig_2.0.3     desc_1.4.2         </span></span>
<span><span class="co">## [46] pkgdown_2.0.7.9000  bslib_0.4.2         Rcpp_1.0.10        </span></span>
<span><span class="co">## [49] glue_1.6.2          data.table_1.14.6   systemfonts_1.0.4  </span></span>
<span><span class="co">## [52] xfun_0.37           knitr_1.42          htmltools_0.5.4    </span></span>
<span><span class="co">## [55] rmarkdown_2.20      compiler_4.3.0      prettyunits_1.1.1</span></span></code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Johannes Rainer.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.9000.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
